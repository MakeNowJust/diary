{"componentChunkName":"component---src-templates-post-js","path":"/post/2016-12-25-array-concat-begin-akiyumekukuru/","webpackCompilationHash":"52fac1dd3495987b125f","result":{"data":{"site":{"siteMetadata":{"title":"℘ make now just"}},"markdownRemark":{"html":"<script async src=\"//cdn.embedly.com/widgets/platform.js\"></script>\n<p>そういやエリナー・リグビー聴いてないな。</p>\n<h1>やったこと</h1>\n<h2><code>Array#concat</code>が和型を受け取れるようにした</h2>\n<p><a class=\"embedly-card\" href=\"https://github.com/crystal-lang/crystal/pull/3775\">Fix to concat a union of arrays by MakeNowJust · Pull Request #3775 · crystal-lang/crystal</a></p>\n<p>どういう意味なのかというと、例えばこういう配列があったとする。</p>\n<pre><code class=\"hljs language-crystal\">arr = [<span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">'2'</span>]</code></pre>\n<p>この配列の型は当然<code>Array(Int32 | Char)</code>だ。</p>\n<p>そして、こういう引数で<code>concat</code>する際には上手く動作する。</p>\n<pre><code class=\"hljs language-crystal\"><span class=\"hljs-comment\"># Array(Int32)</span>\narr.concat([<span class=\"hljs-number\">3</span>])\n<span class=\"hljs-comment\"># Array(Char)</span>\narr.concat([<span class=\"hljs-string\">'4'</span>])\n<span class=\"hljs-comment\"># Array(Int32 | Char)</span>\narr.concat([<span class=\"hljs-number\">5</span>, <span class=\"hljs-string\">'6'</span>])</code></pre>\n<p>しかし、この場合には上手くコンパイルできない。</p>\n<pre><code># Array(Int32) | Array(Char)\narr.concat([7] || ['7'])\n</code></pre>\n<p>なぜかというと、内部で<code>Array(Int32) | Array(Char)</code>が<code>Pointer(Int32) | Pointer(Char)</code>になって、最終的に<code>Pointer(Void)</code>にキャストされようとするのだけど、ポインタの和型は任意のポインタにキャストできるわけではないのでエラーになる。これは挙動としては正しいので、どうにかして<code>concat</code>の引数が和型になるのを防がなければいけない。</p>\n<p>そのために、新しく<code>Array#concat_to</code>というメソッドを作って、<code>concat</code>の内部ではそれを呼ぶようにした。こうすることで和型の各型がばらされて呼び出される形になる。この方法を思い付いたときには結構感動した。</p>\n<h2>あきゆめくくるを始めた</h2>\n<p>買ってきたしやろうと思ってインストールした。普通に楽しいじゃん、という感じ。まだ1ルートも終わってないので何とも言えないけど。</p>","fields":{"date":"2016-12-25"},"frontmatter":{"title":"Array#concatが和型を受け取れるようにしたり、あきゆめくくるを始めたり"},"excerpt":"そういやエリナー・リグビー聴いてないな。 やったこと Array#concatが和型を受け取れるようにした Fix to concat a union of arrays by MakeNowJust · Pull Request #3775 · crystal-lang/cr…"},"prev":{"fields":{"date":"2016-12-26","slug":"/post/2016-12-26-regex-matchdata-expand-spec/"},"frontmatter":{"title":"Regex::MatchDataにメソッドを追加したり、crystal tool expandのテストを書いたり"}},"next":{"fields":{"date":"2016-12-24","slug":"/post/2016-12-24-receipt-printer-iterator-flat-map/"},"frontmatter":{"title":"レシートを印刷しまくったり、Iterator#flat_mapをIteratorを返すようにしたり"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/2016-12-25-array-concat-begin-akiyumekukuru/","prevSlug":"/post/2016-12-26-regex-matchdata-expand-spec/","nextSlug":"/post/2016-12-24-receipt-printer-iterator-flat-map/"}}}