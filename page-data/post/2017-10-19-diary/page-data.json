{"componentChunkName":"component---src-templates-post-js","path":"/post/2017-10-19-diary/","webpackCompilationHash":"41cec0248a3bfa93d288","result":{"data":{"site":{"siteMetadata":{"title":"℘ make now just"}},"markdownRemark":{"html":"<h1>やったこと</h1>\n<h2>マスト丼の鯖を再構築した</h2>\n<p>マスト丼の鯖はConohaのメモリ2GBのプランを使っているのだけど、本来なら50GBあるはずのSSDが20GBしか使えていない。これは元々20GBしかSSDに容量がないメモリ500MBのプランからディスクを移行したせいで起きた問題で、どうもConohaは対処する気がないっぽいので、いい加減鯖を再構築することにした。<code>docker-compose build</code>をする度に容量が無くならないか怯える暮らしは正直しんどい。</p>\n<p>せっかくなのでストレージをConohaのオブジェクトストレージにしたりした。これはそんなに大変じゃなかった。強いて言えば<code>swift</code>コマンドのインストールが面倒で、Homebrewになかったので仕方なくPythonの<code>venv</code>を切って、そこに<code>swift</code>コマンドをインストールした。多分、言語の方のSwiftのコマンドと被るからHomebrewには追加されないのだと思う。</p>\n<p>Conohaのオブジェクトストレージにするための設定は<a href=\"https://gist.github.com/esetomo/7993076bf186aa116df3f97f919bc783\">この辺</a>を参考にした。ありがたい。</p>\n<p>鯖の再構築は18時くらいに始めて、22時くらいに終わったと思う。大半がmastodonで<code>rails assets:precompile</code>すると<code>Permission denied</code>になる謎のバグに費された気がする。これの原因は結局よく分からないけれど、<code>public/packs</code>を消すと上手く動いたりする。</p>\n<p>以下やったことまとめ（覚えている限り時系列順）。</p>\n<ul>\n<li>元の鯖の<code>h2o</code>を落とす</li>\n<li>元の鯖から手元にバックアップを取る</li>\n<li>元の鯖のマスト丼のSQLダンプを取る</li>\n<li>Mastodonのリポジトリのrebase</li>\n<li>新しくサーバーを立てる</li>\n<li><code>pacaur</code>のインストール</li>\n<li>\n<p><code>docker-compose</code>, <code>h2o</code>, <code>certbot</code>, <code>mackerel-agent</code>のインストール</p>\n<ul>\n<li><code>mackerel-agent</code>のインストールは地味にしんどかった。(AURのビルドスクリプトが死んでるので)</li>\n</ul>\n</li>\n<li><code>docker-compose</code>でマスト丼を起動</li>\n<li><code>h2o</code>の設定を元の鯖から持ってくる</li>\n<li>DNSの設定を変更して新しい鯖を向くようにする</li>\n<li>ここら辺で<code>rails assets:precompile</code>がおかしくなる。がんばる。</li>\n<li>どうにか動くようになる</li>\n<li>アイコンがおかしかったりしたのを修正</li>\n<li><code>eslint</code>をかける</li>\n</ul>\n<p>ちなみにMastodonのバージョンを2.0.0まで上げるとカスタム絵文字が使えるようになる。すごい。</p>\n<p>あとTODO。</p>\n<ul>\n<li>鯖をもうちょい真面目に設定する（セキュリティ周りがいい加減すぎる）</li>\n<li>マスト丼のdailyタスクを回すための仕組みを整える</li>\n</ul>\n<p>他にもやることあった気がする。</p>\n<p>そんな感じです。</p>\n<h1>思うところ</h1>\n<p>個人的なタスクとして、</p>\n<ul>\n<li>Apocrypha観たい</li>\n<li>月姫やりたい</li>\n</ul>\n<p>というのがある。時間を作るぞ。</p>","fields":{"date":"2017-10-19"},"frontmatter":{"title":"マスト丼の鯖を再構築した"},"excerpt":"やったこと マスト丼の鯖を再構築した マスト丼の鯖はConohaのメモリ2GBのプランを使っているのだけど、本来なら50GBあるはずのSSDが20GBしか使えていない。これは元々20GBしかSSDに容量がないメモリ500MBのプランからディスクを移行したせいで起きた問題で、どう…"},"prev":{"fields":{"date":"2017-10-21","slug":"/post/2017-10-21-diary/"},"frontmatter":{"title":"木について考えていた"}},"next":{"fields":{"date":"2017-10-15","slug":"/post/2017-10-15-diary/"},"frontmatter":{"title":"Fate/stay night [Heaven's Feel]を観た"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/2017-10-19-diary/","prevSlug":"/post/2017-10-21-diary/","nextSlug":"/post/2017-10-15-diary/"}}}