<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/0.1dc02b2c8e4712ca7608.css">/*! modern-normalize | MIT License | https://github.com/sindresorhus/modern-normalize */html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}:root{-moz-tab-size:4;-o-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}hr{height:0}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{padding:0}progress{vertical-align:baseline}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}@font-face{font-family:Nova Mono;font-style:normal;font-display:swap;font-weight:400;src:local("Nova Mono Regular "),local("Nova Mono-Regular"),url(/static/nova-mono-latin-400-c8bd120234d06826e566429e3b4feca3.woff2) format("woff2"),url(/static/nova-mono-latin-400-724436907bd34e19da3f513e129444ed.woff) format("woff")}@font-face{font-family:Nova Square;font-style:normal;font-display:swap;font-weight:400;src:local("Nova Square Regular "),local("Nova Square-Regular"),url(/static/nova-square-latin-400-ae4b57f5e959898db382ca5a54bfd348.woff2) format("woff2"),url(/static/nova-square-latin-400-2914c1322fd6ac0f455b4724b1f0d34d.woff) format("woff")}@font-face{font-family:Raleway;font-style:normal;font-display:swap;font-weight:100;src:local("Raleway Thin "),local("Raleway-Thin"),url(/static/raleway-latin-100-735afb75a77e96235694bf56db4bcf4e.woff2) format("woff2"),url(/static/raleway-latin-100-d52dfbc3173753337f0f49d203396d46.woff) format("woff")}@font-face{font-family:Raleway;font-style:italic;font-display:swap;font-weight:100;src:local("Raleway Thin italic"),local("Raleway-Thinitalic"),url(/static/raleway-latin-100italic-73f6760249d5c5a2ec816ac2c4711e09.woff2) format("woff2"),url(/static/raleway-latin-100italic-b95c754a4ce48eb85c2fa77b174edd5f.woff) format("woff")}@font-face{font-family:Raleway;font-style:normal;font-display:swap;font-weight:200;src:local("Raleway Extra Light "),local("Raleway-Extra Light"),url(/static/raleway-latin-200-323561d9ef535b79fc5b44b4d1710ca6.woff2) format("woff2"),url(/static/raleway-latin-200-47d350bdf173b927414517477ece05d7.woff) format("woff")}@font-face{font-family:Raleway;font-style:italic;font-display:swap;font-weight:200;src:local("Raleway Extra Light italic"),local("Raleway-Extra Lightitalic"),url(/static/raleway-latin-200italic-76db40bf9eb7d41ab765eca06fbf0e1e.woff2) format("woff2"),url(/static/raleway-latin-200italic-a62e2b876702e38f8d82e921e33b7796.woff) format("woff")}@font-face{font-family:Raleway;font-style:normal;font-display:swap;font-weight:300;src:local("Raleway Light "),local("Raleway-Light"),url(/static/raleway-latin-300-1acb42d704823f91723455986436f721.woff2) format("woff2"),url(/static/raleway-latin-300-34f26209ba887813c1f5b8aa2c161751.woff) format("woff")}@font-face{font-family:Raleway;font-style:italic;font-display:swap;font-weight:300;src:local("Raleway Light italic"),local("Raleway-Lightitalic"),url(/static/raleway-latin-300italic-4380041f46f7b4bf9107a2a620c45fb0.woff2) format("woff2"),url(/static/raleway-latin-300italic-180725ba58388431af1ef84323c7c73e.woff) format("woff")}@font-face{font-family:Raleway;font-style:normal;font-display:swap;font-weight:400;src:local("Raleway Regular "),local("Raleway-Regular"),url(/static/raleway-latin-400-2075794c8e9e7e48e5fbf1b2313e7adf.woff2) format("woff2"),url(/static/raleway-latin-400-bd67f25d9c25994ffde79d2a81b85a66.woff) format("woff")}@font-face{font-family:Raleway;font-style:italic;font-display:swap;font-weight:400;src:local("Raleway Regular italic"),local("Raleway-Regularitalic"),url(/static/raleway-latin-400italic-de4bb8c8d39843b4d00f591c31e747b4.woff2) format("woff2"),url(/static/raleway-latin-400italic-a5888ae2424dc2ace78d3a9d1cd145ef.woff) format("woff")}@font-face{font-family:Raleway;font-style:normal;font-display:swap;font-weight:500;src:local("Raleway Medium "),local("Raleway-Medium"),url(/static/raleway-latin-500-de818060c850c7842e9f2cb4d409d2ba.woff2) format("woff2"),url(/static/raleway-latin-500-827182817f267a45d66d5505e4ea65ad.woff) format("woff")}@font-face{font-family:Raleway;font-style:italic;font-display:swap;font-weight:500;src:local("Raleway Medium italic"),local("Raleway-Mediumitalic"),url(/static/raleway-latin-500italic-0ed855b4569523aa3db4d45cce2f592b.woff2) format("woff2"),url(/static/raleway-latin-500italic-5fbef688ab145036c4f3fc7675983532.woff) format("woff")}@font-face{font-family:Raleway;font-style:normal;font-display:swap;font-weight:600;src:local("Raleway SemiBold "),local("Raleway-SemiBold"),url(/static/raleway-latin-600-bd2bb116d8276633fec3aba46fe9d254.woff2) format("woff2"),url(/static/raleway-latin-600-eae0742c0c428ed91b2205f6c9c79e29.woff) format("woff")}@font-face{font-family:Raleway;font-style:italic;font-display:swap;font-weight:600;src:local("Raleway SemiBold italic"),local("Raleway-SemiBolditalic"),url(/static/raleway-latin-600italic-c031cce642dbc0f3f2c97a927a27a988.woff2) format("woff2"),url(/static/raleway-latin-600italic-43b080a4cc7d0bf844b697e0bcf8fa47.woff) format("woff")}@font-face{font-family:Raleway;font-style:normal;font-display:swap;font-weight:700;src:local("Raleway Bold "),local("Raleway-Bold"),url(/static/raleway-latin-700-dcbe8703a0a177b692121274ade573cf.woff2) format("woff2"),url(/static/raleway-latin-700-5098f8c8aa542824cd5410ef903e48e0.woff) format("woff")}@font-face{font-family:Raleway;font-style:italic;font-display:swap;font-weight:700;src:local("Raleway Bold italic"),local("Raleway-Bolditalic"),url(/static/raleway-latin-700italic-52a8c3f81d98d06743bd9e1a0c08632a.woff2) format("woff2"),url(/static/raleway-latin-700italic-bfa3acd9e4abc9fa5a755aee96132c3b.woff) format("woff")}@font-face{font-family:Raleway;font-style:normal;font-display:swap;font-weight:800;src:local("Raleway ExtraBold "),local("Raleway-ExtraBold"),url(/static/raleway-latin-800-47609ca009fcc8c0b7e6c54c0642c209.woff2) format("woff2"),url(/static/raleway-latin-800-2277f1ba3868654aa7410d6e92033eb2.woff) format("woff")}@font-face{font-family:Raleway;font-style:italic;font-display:swap;font-weight:800;src:local("Raleway ExtraBold italic"),local("Raleway-ExtraBolditalic"),url(/static/raleway-latin-800italic-e571e4c8ea969ff4293fd5a9188a9565.woff2) format("woff2"),url(/static/raleway-latin-800italic-b12796f572af240e5d48d02fb80d9b55.woff) format("woff")}@font-face{font-family:Raleway;font-style:normal;font-display:swap;font-weight:900;src:local("Raleway Black "),local("Raleway-Black"),url(/static/raleway-latin-900-0f85e4bfe865defa18588fc8e8448611.woff2) format("woff2"),url(/static/raleway-latin-900-a58f25dc87faec123dd985c60acd54ff.woff) format("woff")}@font-face{font-family:Raleway;font-style:italic;font-display:swap;font-weight:900;src:local("Raleway Black italic"),local("Raleway-Blackitalic"),url(/static/raleway-latin-900italic-c8f1b2c3f2786b6b40e584c71e3cb77d.woff2) format("woff2"),url(/static/raleway-latin-900italic-f202fc5be52c2852b32de0c69a2c7de0.woff) format("woff")}</style><style data-href="/component---src-templates-post-js.e7bfc5737c1958cb7f27.css">@charset "UTF-8";.header-module--container--1n86u{padding:10em 0}.header-module--title--33kOg{font-family:Nova Mono,Monaco,monospace;text-align:center}.header-module--title--33kOg>a{color:#434944}.footer-module--copyright--4FyNV,.header-module--quote--TnsFz{text-align:center}html{color:#6c6d6b;background-color:#fbfbf8;font-family:Raleway,游ゴシック,Yu Gothic,游ゴシック体,YuGothic,sans-serif;font-size:16px;-webkit-font-feature-settings:"palt";font-feature-settings:"palt";line-height:1.8}blockquote,h1,h2,h3,h4,h5,h6,hr,ol,p,pre,table,ul{max-width:860px;margin:0 auto 1.8rem;padding:0 .5rem}li>blockquote,li>h1,li>h2,li>h3,li>h4,li>h5,li>h6,li>hr,li>ol,li>p,li>pre,li>table,li>ul{margin:1rem 0}h1,h2,h3,h4,h5,h6{color:#434944;font-family:Nova Square,游ゴシック,Yu Gothic,游ゴシック体,YuGothic,sans-serif}h1{font-size:32px}h2{font-size:29.33333px}h3{font-size:26.66667px}h4{font-size:24px}h5{font-size:21.33333px}h6{font-size:18.66667px}a{color:#5cabdc;text-decoration:none}a:hover{text-decoration:underline}code{padding:0 .25em;color:#fbfbf8;background-color:#6c6d6b;font-family:Nova Mono,Monaco,monospace}pre{width:100%;max-width:none;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-spacing:normal;white-space:pre;word-break:normal;word-wrap:normal;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre,pre>code{background-color:#434944}pre>code{display:block;max-width:860px;padding:.5em;margin:0 auto;color:#fbfbf8;line-height:1.55;overflow-x:auto}pre>code .token.cdata,pre>code .token.comment,pre>code .token.doctype,pre>code .token.prolog{color:#6c6d6b}pre>code .token.punctuation{color:#b595cf}pre>code .token.boolean,pre>code .token.constant,pre>code .token.deleted,pre>code .token.number,pre>code .token.property,pre>code .token.symbol,pre>code .token.tag{color:#5cabdc}pre>code .token.attr-name,pre>code .token.builtin,pre>code .token.char,pre>code .token.inserted,pre>code .token.selector,pre>code .token.string,pre>code .token.url{color:#44a9ba}pre>code .token.atrule,pre>code .token.attr-value,pre>code .token.keyword{color:#8cc16d}pre>code .token.class-name,pre>code .token.function{color:#eebf35}pre>code .token.important,pre>code .token.regex,pre>code .token.variable{color:#da5673}pre>code .token.bold,pre>code .token.important{font-weight:700}pre>code .token.entity{color:#bfc2bc;background:#6c6d6b;cursor:help}pre>code .token.italic{font-style:italic}table{display:block;border-collapse:collapse;overflow-x:auto}table th{color:#fbfbf8;background-color:#434944;font-weight:400}table td,table th{padding:.25rem;border:1px solid #6c6d6b}img{height:auto;max-width:100%}blockquote{padding:.5rem 0 .5rem 1rem;border-left:.25rem solid #434944}blockquote>:first-child{margin-top:0}blockquote>:last-child{margin-bottom:0}.post-module--title--hTIc5{text-decoration:underline}.post-module--around-links--1kjII{margin-bottom:1.8rem}.post-module--prev-link--3N6VD{margin-bottom:0}.post-module--current-title--1Du8H{text-align:center;margin-bottom:0}.post-module--next-link--1_Xv8{text-align:right;margin-bottom:0}</style><meta name="generator" content="Gatsby 2.0.25"/><title data-react-helmet="true">2016-12-10: Crystalでシリアルポートに接続するライブラリを作った | ℘ make now just</title><meta data-react-helmet="true" name="description" content="この記事は Crystal Advent Calendar 2016 の10日目の記事です。9日目はいなかったみたいです、残念。 一行で Crystalでシリアルポートに接続するライブラリを作ったよ MakeNowJust/serialport: serial port lib…"/><link as="script" rel="preload" href="/component---src-templates-post-js-188481b9d7be85a673d2.js"/><link as="script" rel="preload" href="/0-6cc198b83c40109d2d51.js"/><link as="script" rel="preload" href="/app-c5c53c408f3748d219e9.js"/><link as="script" rel="preload" href="/webpack-runtime-031eedd2a97ed558193d.js"/><link rel="preload" href="/static/d/572/path---post-2016-12-10-serial-port-written-in-crystal-844-068-qL7ruJhc51ZG9RjH0LFvy5vVDw.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><header class="header-module--container--1n86u"><h1 class="header-module--title--33kOg"><a href="/">℘ make now just</a></h1><p class="header-module--quote--TnsFz">if you wanna break free you better listen to me</p></header><main><article><h1 class="post-module--title--hTIc5">2016-12-10<!-- -->: <!-- -->Crystalでシリアルポートに接続するライブラリを作った</h1><div><script async src="//cdn.embedly.com/widgets/platform.js"></script>
<script async src="//platform.twitter.com/widgets.js"></script>
<p>この記事は<a href="http://qiita.com/advent-calendar/2016/crystal">Crystal Advent Calendar 2016</a>の10日目の記事です。9日目はいなかったみたいです、残念。</p>
<h1>一行で</h1>
<p>Crystalでシリアルポートに接続するライブラリを作ったよ</p>
<p><a class="embedly-card" data-card-width="100%" data-card-controls="0" href="https://github.com/MakeNowJust/serialport">MakeNowJust/serialport: serial port library for Crystal</a></p>
<h1>本編</h1>
<h2>流れ</h2>
<p>本来ならボクはAdvent CalendarにCrystalで<code>memcached</code>を実装したものを記事にして投稿するつもりだったのですが、今一面白い記事が書けそうになかったので挫折しました。<code>Hash</code>の再実装とかしたくない‥‥。</p>
<p>そして今日になって、バイトの最中で微妙にやることがなくなって手持ち無沙汰にしていたところ社長にAdvent Calendarのことを話したら、会社のことを絡めるなら仕事中に書いてもいいと言われたのでどうにかして会社を絡めたネタを考えました。</p>
<p>で、どうしてシリアルポートなのかというと、ボクのバイトしている<a href="http://nyampass.com/">ニャンパス</a>ではIoTデバイスの開発もいくつか行なっています。その中にはいくつかシリアルポートを介してPCから信号を受け取り動作するデバイスや、その逆にシリアルポートでデータをPCへと送信デバイスがあります。Crystalを使ってそれらを制御できたら面白そうだったので、これをAdvent Calendarのテーマとしようと決めました。</p>
<p>それで少し調べてみたところ、<a href="https://github.com/marceloboeira/serial.cr">serial.cr</a>というlibserialportのバインディングらしき何かは見つけたのですが、どうもcrystal-libを適用する前のコードしか置かれていなくて全く使いものにならなそうなので、諦めて自作することにしたという次第です。というかこのMacBook Airにはlibserialportはインストールされていません。</p>
<h2>どんなライブラリを作るか考える</h2>
<p>Crystalには<a href="https://crystal-lang.org/api/0.20.1/IO/FileDescriptor.html"><code>IO::FileDescriptor</code></a>というクラスがあります。これはファイルデスクリプタをラップして<code>IO</code>クラスを実装したものです。つまり、ファイルデスクリプタがあれば<code>gets</code>メソッドや<code>&#x3C;&#x3C;</code>メソッドを使うことができるようになります。<br>
（余談ですが、この<code>IO::FileDescriptor</code>クラスは<code>File</code>クラスや<code>Socket</code>クラスのスーパークラスです）</p>
<p><code>IO</code>クラスを実装しているので、<code>to_s</code>に渡したり<code>to_json</code>に渡したりと様々なことができるようになります。<code>IO</code>クラスは本当にCrystalの骨幹をなしています。<code>IO</code>クラスを制するものはCrystalを制すると言っても過言ではないでしょう。Crystalにおけるリバウンドであるというわけです。</p>
<p>また、C言語でシリアルポートを扱う際には<code>open</code>関数で<code>/dev</code>以下にあるデバイスファイルをオープンし、シリアルポート独特の設定をしたファイルデスクリプタに対して<code>write</code>や<code>read</code>をするみたいです。ちょうどいいですね。</p>
<p>というわけで、<code>IO::FileDescriptor</code>を継承し、<code>initialize</code>でファイルデスクリプタを設定して<code>super</code>に渡すようなクラスを作ることにしました。</p>
<h2><code>IO::FileDescriptor</code>を継承したクラスの作り方</h2>
<p>基本的にはこんな形になります。</p>
<div class="gatsby-highlight" data-language="crystal"><pre class="language-crystal"><code class="language-crystal"><span class="token keyword">class</span> <span class="token class-name">HogeFile</span> <span class="token operator">&lt;</span> <span class="token builtin">IO</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">FileDescriptor</span>
  <span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span>path <span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
    <span class="token comment"># C言語の`open`関数を呼び出して、ファイルデスクリプタを得る</span>
    <span class="token comment"># 引数の`path`に対して`check_no_null_byte`を呼び出して、C言語に渡しても問題のない文字列かチェックしている</span>
    fd <span class="token operator">=</span> <span class="token constant">LibC</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>check_no_null_byte<span class="token punctuation">,</span> <span class="token constant">LibC</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">O_RDWR</span><span class="token punctuation">)</span>

    <span class="token comment"># C言語の関数は失敗したからと言って例外を投げてくれないので、自前でチェックする必要がある</span>
    <span class="token keyword">if</span> fd <span class="token operator">&lt;</span> <span class="token number">0</span>
      raise <span class="token constant">Error</span><span class="token punctuation">.</span>new <span class="token string">"cannot open '<span class="token interpolation"><span class="token delimiter tag">#{</span>path<span class="token delimiter tag">}</span></span>'"</span>
    <span class="token keyword">end</span>

    <span class="token comment"># （この辺で各クラス固有のファイルデスクリプタの設定をする）</span>

    <span class="token comment"># `IO::FileDescriptor`をさっき得たファイルデスクリプタで初期化する</span>
    <span class="token keyword">super</span> fd
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p>事実、これだけのコードで<code>File</code>クラスのようにファイルを読み書きできるようになります。</p>
<p>そして、実際の<code>SerialPort</code>クラスはこうなりました。</p>
<div class="gatsby-highlight" data-language="crystal"><pre class="language-crystal"><code class="language-crystal"><span class="token keyword">class</span> <span class="token class-name">SerialPort</span> <span class="token operator">&lt;</span> <span class="token builtin">IO</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">FileDescriptor</span>
  <span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token variable">@path</span> <span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> baudrate <span class="token punctuation">:</span> <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">BaudRate</span><span class="token punctuation">,</span> blocking <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    oflag <span class="token operator">=</span> <span class="token constant">LibC</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">O_RDWR</span> <span class="token operator">|</span> <span class="token constant">LibC</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">O_NOCTTY</span> <span class="token operator">|</span> <span class="token constant">LibC</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">O_SYNC</span> <span class="token operator">|</span> <span class="token constant">LibC</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">O_CLOEXEC</span>

    fd <span class="token operator">=</span> <span class="token constant">LibC</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>check_no_null_byte<span class="token punctuation">,</span> oflag<span class="token punctuation">)</span>
    <span class="token keyword">if</span> fd <span class="token operator">&lt;</span> <span class="token number">0</span>
      raise <span class="token constant">Errno</span><span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"Error opening serial port '<span class="token interpolation"><span class="token delimiter tag">#{</span>path<span class="token delimiter tag">}</span></span>'"</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token keyword">self</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment"># no buffering</span>

    <span class="token function">set_interface_attributes</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> baudrate<span class="token punctuation">,</span> blocking<span class="token punctuation">)</span>
    <span class="token keyword">super</span> fd<span class="token punctuation">,</span> blocking
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre></div>
<p>さきほどの<code>HogeFile</code>と比べると、<code>initialize</code>の引数に<code>baudrate</code>や<code>blocking</code>が増えていることが分かります。<code>baudrate</code>はシリアルポートのボードレートを指定するもので、<code>blocking</code>は<code>IO::FileDescriptor</code>にも元から存在する引数で、IOがブロックするかどうかを指定します。基本的には非同期の方がいいでしょう。</p>
<p>また、途中に<code>self.sync = true</code>という行がありますが、これは<code>IO::Buffered</code>を<code>include</code>しているので、バッファリングしないようにするためです。シリアルポートでバッファリングされるといつデータが送られるのか分からなくなってちょっと困ります。</p>
<p>最後の方に<code>set_interface_attributes</code>というメソッドの呼び出しがありますが、これが今回の実装のキモです。ここで<code>fd</code>をシリアルポート向けに設定します。</p>
<h2><code>set_interface_attributes</code>の実装</h2>
<p><code>set_interface_attributes</code>はC言語でシリアルポートに接続するコードを参考にして、次のようになりました。<br>
（もちろんこのコードは実際には<code>class SerialPort &#x3C; IO::FileDescriptor</code>の中にあります）</p>
<div class="gatsby-highlight" data-language="crystal"><pre class="language-crystal"><code class="language-crystal">  <span class="token keyword">private</span> <span class="token keyword">def</span> <span class="token function">set_interface_attributes</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> baudrate<span class="token punctuation">,</span> blocking<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token constant">LibC</span><span class="token punctuation">.</span><span class="token function">tcgetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token keyword">out</span> mode<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
      raise <span class="token constant">Error</span><span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"initialize serial port: tcgetaddr"</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token constant">LibC</span><span class="token punctuation">.</span><span class="token function">cfsetospeed</span><span class="token punctuation">(</span><span class="token keyword">pointerof</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">,</span> baudrate<span class="token punctuation">)</span>
    <span class="token constant">LibC</span><span class="token punctuation">.</span><span class="token function">cfsetispeed</span><span class="token punctuation">(</span><span class="token keyword">pointerof</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">,</span> baudrate<span class="token punctuation">)</span>

    mode<span class="token punctuation">.</span>c_cflag <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ControlMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">CLOCAL</span> <span class="token operator">|</span>
                     <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ControlMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">CREAD</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment"># ignore modem controls</span>
    mode<span class="token punctuation">.</span>c_cflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ControlMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">CSIZE</span><span class="token punctuation">.</span>value
    mode<span class="token punctuation">.</span>c_cflag <span class="token operator">|</span><span class="token operator">=</span> <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ControlMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">CS8</span><span class="token punctuation">.</span>value     <span class="token comment"># 8-bit characters</span>
    mode<span class="token punctuation">.</span>c_cflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ControlMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">PARENB</span><span class="token punctuation">.</span>value <span class="token comment"># no parity bit</span>
    mode<span class="token punctuation">.</span>c_cflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ControlMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">CSTOPB</span><span class="token punctuation">.</span>value <span class="token comment"># only need 1 stop bit</span>
    mode<span class="token punctuation">.</span>c_cflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token constant">LibC</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">CRTSCTS</span>                      <span class="token comment"># no hardware flowcontrol</span>

    mode<span class="token punctuation">.</span>c_iflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">InputMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">IGNBRK</span> <span class="token operator">|</span>
                      <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">InputMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">BRKINT</span> <span class="token operator">|</span>
                      <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">InputMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">PARMRK</span> <span class="token operator">|</span>
                      <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">InputMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ISTRIP</span> <span class="token operator">|</span>
                      <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">InputMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">INLCR</span> <span class="token operator">|</span>
                      <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">InputMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">IGNCR</span> <span class="token operator">|</span>
                      <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">InputMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ICRNL</span> <span class="token operator">|</span>
                      <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">InputMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">IXON</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value
    mode<span class="token punctuation">.</span>c_lflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">LocalMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ECHO</span> <span class="token operator">|</span>
                      <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">LocalMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ECHONL</span> <span class="token operator">|</span>
                      <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">LocalMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ICANON</span> <span class="token operator">|</span>
                      <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">LocalMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ISIG</span> <span class="token operator">|</span>
                      <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">LocalMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">IEXTEN</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value
    mode<span class="token punctuation">.</span>c_oflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span><span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">OutputMode</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">OPOST</span><span class="token punctuation">.</span>value

    mode<span class="token punctuation">.</span>c_cc<span class="token punctuation">[</span><span class="token constant">LibC</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">VMIN</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocking <span class="token operator">?</span> <span class="token number">1_u8</span> <span class="token punctuation">:</span> <span class="token number">0_u8</span>
    mode<span class="token punctuation">.</span>c_cc<span class="token punctuation">[</span><span class="token constant">LibC</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">VTIME</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5_u8</span>

    <span class="token keyword">if</span> <span class="token constant">LibC</span><span class="token punctuation">.</span><span class="token function">tcsetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">LineControl</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">TCSANOW</span><span class="token punctuation">,</span> <span class="token keyword">pointerof</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span>
      raise <span class="token constant">Error</span><span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"initialize serial port: tcsetattr"</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span></code></pre></div>
<p>特徴的なのは、冒頭で<code>LibC.tcgetattr(fd, out mode)</code>と<code>out</code>パラメーターを使って<code>mode</code>を受け取っていることでしょうか。</p>
<p>さて、ここで一つ問題が発生しました。Crystalは標準ライブラリに<code>termios.h</code>に対するバインディングをいくつか提供しているのですが、今回利用したい全てに対応しているというわけではありません。<br>
しかし、幸いにもCrystalにはC言語の関数や定数を簡単に定義できる仕組みがあります。さくっと<code>libc.cr</code>というファイルを作って、足りない関数や定数を補うことにしました。<br>
（定数の値や関数のプロトタイプ宣言などは、実際にヘッダファイルを見たり<code>man</code>ページを参考にして記述しました）</p>
<div class="gatsby-highlight" data-language="crystal"><pre class="language-crystal"><code class="language-crystal"><span class="token keyword">lib</span> <span class="token constant">LibC</span>
  <span class="token comment"># from fnctl.h</span>
  <span class="token constant">O_NOCTTY</span> <span class="token operator">=</span> <span class="token number">0x20000</span>

  <span class="token comment"># from termios.h</span>
  <span class="token constant">CCTS_OFLOW</span> <span class="token operator">=</span> <span class="token number">0x00010000</span>
  <span class="token constant">CRTS_IFLOW</span> <span class="token operator">=</span> <span class="token number">0x00020000</span>
  <span class="token constant">CDTR_IFLOW</span> <span class="token operator">=</span> <span class="token number">0x00040000</span>
  <span class="token constant">CDSR_OFLOW</span> <span class="token operator">=</span> <span class="token number">0x00080000</span>
  <span class="token constant">CCAR_OFLOW</span> <span class="token operator">=</span> <span class="token number">0x00100000</span>
  <span class="token constant">CRTSCTS</span>    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">CCTS_OFLOW</span> <span class="token operator">|</span> <span class="token constant">CRTS_IFLOW</span><span class="token punctuation">)</span>

  <span class="token constant">VTIME</span> <span class="token operator">=</span> <span class="token number">17</span>

  <span class="token keyword">fun</span> <span class="token function">cfsetospeed</span><span class="token punctuation">(</span>termios_p <span class="token punctuation">:</span> <span class="token constant">Termios</span><span class="token operator">*</span><span class="token punctuation">,</span> speed <span class="token punctuation">:</span> <span class="token constant">SpeedT</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token constant">Int</span>
  <span class="token keyword">fun</span> <span class="token function">cfsetispeed</span><span class="token punctuation">(</span>termios_p <span class="token punctuation">:</span> <span class="token constant">Termios</span><span class="token operator">*</span><span class="token punctuation">,</span> speed <span class="token punctuation">:</span> <span class="token constant">SpeedT</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token constant">Int</span>

  <span class="token keyword">fun</span> <span class="token function">tcdrain</span><span class="token punctuation">(</span>fd <span class="token punctuation">:</span> <span class="token constant">Int</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token constant">Int</span>
<span class="token keyword">end</span></code></pre></div>
<p>さりげなく<code>initialize</code>の方にも本来は定義されていない定数があったことがバレてしまいましたね。</p>
<p>とりあえず、こんな風にしてCrystalでシリアルポートに接続するライブラリは完成しました、一応。</p>
<h2>それで、作ったもの。</h2>
<p>これです。</p>
<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">なんなのか‥‥ <a href="https://t.co/n1j8mpsPU7">pic.twitter.com/n1j8mpsPU7</a></p>&mdash; さっき作った@3日目東R-13a (@make_now_just) <a href="https://twitter.com/make_now_just/status/807514728931041281">2016年12月10日</a></blockquote>
<p>なんなのか‥‥。</p>
<p>ちなみに、これを動かしたCrystalのスクリプトはこんな感じです。</p>
<div class="gatsby-highlight" data-language="crystal"><pre class="language-crystal"><code class="language-crystal"><span class="token keyword">require</span> <span class="token string">"./src/serialport"</span>

serial <span class="token operator">=</span> <span class="token constant">SerialPort</span><span class="token punctuation">.</span>new <span class="token string">"/dev/なんとかかんとか"</span><span class="token punctuation">,</span> <span class="token constant">Termios</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">BaudRate</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">B9600</span>

i <span class="token operator">=</span> <span class="token number">0</span>
loop <span class="token keyword">do</span>
  serial <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token string">"v <span class="token interpolation"><span class="token delimiter tag">#{</span>i<span class="token delimiter tag">}</span></span>"</span>
  i <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1024</span>
  sleep <span class="token number">0.1</span>
<span class="token keyword">end</span></code></pre></div>
<p>シリアルポートに「v 0-1023の数値」の形式で書き込むと数値に対応した位置までサーボモーターが動くというものが会社にあったので、それを動かしまくってみました。なんともシュールな光景になったと思います。このデバイスを作った人にはサーボモーターに負荷がかかるからやめろと言われました‥‥。ごめんなさい。</p>
<p>あと、シリアルポートを読み取る方のプログラムも書いたことには書いたのですが、センサーが不調だったようで上手く結果が取れなかったので非公開としておきます。</p>
<h2>今後の課題とか</h2>
<ul>
<li>Linuxや他の環境でも動くようにする（手元で動けばいいという気持ちで作ったから他の環境のことを考えていない。多分Cバインディング周りで、定数の値が違うからコケる）</li>
<li>テストを書く（どうやって書けばいいんすか‥‥）</li>
<li>シリアルポートに対してもっと細かく設定できるようにする（この辺は他のライブラリを参考にしたい）</li>
<li>というかもっとシリアルポートについて理解を深めろ（ぶっちゃけよく分かってない）</li>
</ul>
<p>誰かLinuxに移植したりテスト書いといたりしといてください。Pull Requestはいつでも待っています。</p>
<h1>最後に</h1>
<p>CrystalではC言語と簡単に連携できると言いますが、その例は大抵がC言語の関数を呼び出すところで終わってしまいます。しかし、本来ならばその先に、C言語の関数をCrystalらしく使えるようにする、という作業が残っているはずです。今回の記事では、その部分に少しフォーカスを当ててみたつもりです。</p>
<p>あと勢いでシリアルポートに繋ぐライブラリを作ってみましたが、これって使い途あるんでしょうか？　Crystalでシリアルポートにつなぎたい機会ってあります？　スクリプト言語の方がよくありません？　あ、でも組み込みで動かすときとかだと話は別なのかな‥‥。いや、Crystal組み込みで動かねえし‥‥。</p>
<p>とまあ使い途がよく分からなくなっているのですが、Crystalでシリアルポートに繋ぎたくなったらぜひ使ってみてください。</p>
<p>あと、もしもこの記事でニャンパスに興味を持った方がいたら、Halake（ニャンパスが運営しているコワーキングスペースです）に来たときに「MakeNowJustの記事を読んだよ」と言ってください。そうするとボクの給料が増えて日本経済を回すきっかけになる可能性があります。いや、ねーよ。</p>
<p>最後にどうしてボクがひたすらCrystalにコントリビュートしているのか書いたらかっこいいなとか思ったのですが、特に理由がありませんでした。強いて言えばpineさんがcrystal-jpとかやってるのについかっとなってやったとかそんな感じでしょうか（本当です）。完全にキレる若者ですね。若者ってこえー。</p>
<p>というわけでここまで読んでいただきありがとうございました。ありがとうございます。</p></div></article><hr/><section class="post-module--around-links--1kjII"><p class="post-module--prev-link--3N6VD"><a href="/post/2016-12-11-neu-swanstein-castle/">2016-12-11<!-- -->: <!-- -->ノイシュバンシュタイン城というボドゲで遊んだ</a></p><p class="post-module--current-title--1Du8H">2016-12-10<!-- -->: <!-- -->Crystalでシリアルポートに接続するライブラリを作った</p><p class="post-module--next-link--1_Xv8"><a href="/post/2016-12-10-bashcached-pr-init-shard-yml/">2016-12-10<!-- -->: <!-- -->bashcachedにPull Requestがきたり、crystal init libで生成されるshard.ymlを直したり</a></p></section></main><footer><p class="footer-module--copyright--4FyNV">© <!-- -->2016-2018<!-- --> <!-- -->TSUYUSATO<!-- --> &quot;<a href="https://github.com/MakeNowJust">MakeNowJust</a>&quot; <!-- -->Kitsune</p></footer></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-post-js","jsonName":"post-2016-12-10-serial-port-written-in-crystal-844","path":"/post/2016-12-10-serial-port-written-in-crystal/"};window.dataPath="572/path---post-2016-12-10-serial-port-written-in-crystal-844-068-qL7ruJhc51ZG9RjH0LFvy5vVDw";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-c5c53c408f3748d219e9.js"],"component---src-templates-post-js":["/component---src-templates-post-js.e7bfc5737c1958cb7f27.css","/component---src-templates-post-js-188481b9d7be85a673d2.js"],"component---src-templates-list-js":["/component---src-templates-list-js.30685681bc959f24cc83.css","/component---src-templates-list-js-3bf0d719c3b33dbfdf86.js"]};/*]]>*/</script><script src="/webpack-runtime-031eedd2a97ed558193d.js" async=""></script><script src="/app-c5c53c408f3748d219e9.js" async=""></script><script src="/0-6cc198b83c40109d2d51.js" async=""></script><script src="/component---src-templates-post-js-188481b9d7be85a673d2.js" async=""></script></body></html>